const e=await import("../../token-action-hud-core/scripts/token-action-hud-core.min.js"),t=e.ActionHandler,s=e.ActionListExtender,i=e.CategoryManager,n=e.PreRollHandler,a=e.RollHandler,o=e.SystemManager,l=e.Logger,c="token-action-hud-dnd5e";function getSetting(e,t=null){let s=t??null;try{s=game.settings.get(c,e)}catch{l.debug(`Setting '${e}' not found`)}return s}async function setSetting(e,t){game.settings.settings.get(`${c}.${e}`)?(t=await game.settings.set(c,e,t),l.debug(`Setting '${e}' set to '${t}'`)):l.debug(`Setting '${e}' not found`)}class ActionHandler extends t{actor=null;actors=null;actorId=null;actorType=null;character=null;token=null;tokenId=null;items=null;abbreviateSkills=null;displaySpellInfo=null;showItemsWithoutActivationCosts=null;showUnchargedItems=null;showUnequippedItems=null;showUnpreparedSpells=null;subcategoryIds=null;actionSubcategoryIds=null;effectSubcategoryIds=null;featureSubcategoryIds=null;inventorySubcategoryIds=null;spellSubcategoryIds=null;featureActions=null;inventoryActions=null;spellActions=null;async buildSystemActions(e,t){this.actor=e?.actor,this.actorId=this.actor?.id??"multi",this.actors="multi"===this.actorId?this._getActors():[this.actor],this.actorType=this.actor?.type,this.token=e?.token,this.tokenId=this.token?.id??"multi";let s=this.actor.items;return s=this._discardSlowItems(s),s=this.sortItemsByName(s),this.items=s,this.abbreviateSkills=getSetting("abbreviateSkills"),this.displaySpellInfo=getSetting("displaySpellInfo"),this.showItemsWithoutActivationCosts=getSetting("showItemsWithoutActivationCosts"),this.showUnchargedItems=getSetting("showUnchargedItems"),this.showUnequippedItems=getSetting("showUnequippedItems"),this.showUnpreparedSpells=getSetting("showUnpreparedSpells"),this.subcategoryIds=t,this.actionSubcategoryIds=t.filter((e=>"actions"===e||"bonus-actions"===e||"crew-actions"===e||"lair-actions"===e||"legendary-actions"===e||"reactions"===e||"other-actions"===e)),this.effectSubcategoryIds=t.filter((e=>"passive-effects"===e||"temporary-effects"===e)),this.featureSubcategoryIds=t.filter((e=>"active-features"===e||"passive-features"===e)),this.spellSubcategoryIds=t.filter((e=>"cantrips"===e||"1st-level-spells"===e||"2nd-level-spells"===e||"3rd-level-spells"===e||"4th-level-spells"===e||"5th-level-spells"===e||"6th-level-spells"===e||"7th-level-spells"===e||"8th-level-spells"===e||"9th-level-spells"===e||"at-will-spells"===e||"innate-spells"===e||"pact-spells"===e)),"character"===this.actorType||"npc"===this.actorType?(this.inventorySubcategoryIds=t.filter((e=>"equipped"===e||"consumables"===e||"containers"===e||"equipment"===e||"loot"===e||"tools"===e||"weapons"===e||"unequipped"===e)),this._buildCharacterActions()):"vehicle"===this.actorType?(this.inventorySubcategoryIds=this.subcategoryIds.filter((e=>"consumables"===e||"equipment"===e||"tools"===e||"weapons"===e)),this._buildVehicleActions()):this.actor?void 0:this._buildMultipleTokenActions()}async _buildCharacterActions(){this._buildAbilities("ability","abilities"),this._buildAbilities("abilityCheck","checks"),this._buildAbilities("abilitySave","saves"),this._buildCombat(),this._buildConditions(),this._buildEffects(),this._buildFeatures(),this._buildInventory(),this._buildRests(),this._buildSkills(),this._buildSpells(),this._buildUtility()}async _buildVehicleActions(){this._buildAbilities("ability","abilities"),this._buildAbilities("abilityCheck","checks"),this._buildAbilities("abilitySave","saves"),this._buildCombat(),this._buildConditions(),this._buildEffects(),this._buildFeatures(),this._buildInventory(),this._buildUtility()}async _buildMultipleTokenActions(){this._buildAbilities("ability","abilities"),this._buildAbilities("abilityCheck","checks"),this._buildAbilities("abilitySave","saves"),this._buildCombat(),this._buildConditions(),this._buildRests(),this._buildSkills(),this._buildUtility()}_buildAbilities(e,t){if(!this.subcategoryIds.some((e=>e===t)))return;const s="multi"===this.actorId?game.dnd5e.config.abilities:this.actor.system.abilities;if(0===s.length)return;const i=Object.entries(s).filter((e=>0!==s[e[0]].value)).map((i=>{const n=i[0],a=n.charAt(0).toUpperCase()+n.slice(1),o=this.abbreviateSkills?a:game.dnd5e.config.abilities[n],l=[e,this.actorId,this.tokenId,n].join(this.delimiter);return{id:n,name:o,encodedValue:l,icon:"checks"!==t?this._getProficiencyIcon(s[n].proficient):"",selected:!0}}));this.addActionsToActionList(i,t)}_buildCombat(e){if(!this.subcategoryIds.some((e=>"combat"===e)))return;const t="utility",s={initiative:{id:"initiative",name:this.i18n("tokenActionHud.dnd5e.rollInitiative")},endTurn:{id:"endTurn",name:this.i18n("tokenActionHud.endTurn")}};game.combat?.current?.tokenId!==this.tokenId&&delete s.endTurn;const i=Object.entries(s).map((e=>{const s=e[1].id,i=e[1].name,n=[t,this.actorId,this.tokenId,s].join(this.delimiter);let a="",o="";if("initiative"===e[0]&&game.combat){const e=canvas.tokens.controlled.map((e=>e.id)),t=game.combat.combatants.filter((t=>e.includes(t.tokenId)));if(1===t.length){a=t[0].initiative}o=`toggle${t.length>0&&t.every((e=>e?.initiative))?" active":""}`}return{id:s,name:i,encodedValue:n,info1:a,cssClass:o,selected:!0}}));this.addActionsToActionList(i,"combat")}_buildConditions(){if(!this.subcategoryIds.some((e=>"conditions"===e)))return;if(!this.token)return;const e="condition",t=CONFIG.statusEffects.filter((e=>""!==e.id));if(0===t.length)return;const s=t.map((t=>{const s=t.id,i=this.i18n(t.label),n=[e,this.actorId,this.tokenId,s].join(this.delimiter),a=`toggle${this.actors.every((e=>e.effects.map((e=>e.flags?.core?.statusId)).some((e=>e===s))))?" active":""}`,o=t.icon;return{id:s,name:i,encodedValue:n,img:o,cssClass:a,selected:!0}}));this.addActionsToActionList(s,"conditions")}_buildEffects(){if(!this.effectSubcategoryIds)return;const e="effect",t=this.actor.effects;if(0===t.size)return;const s=new Map,i=new Map;for(const e of t){const t=e.id;e.isTemporary?i.set(t,e):s.set(t,e)}if(this.effectSubcategoryIds.some((e=>"passive-effects"===e))){const t="passive-effects";this._buildActions(s,{id:t},e)}if(this.effectSubcategoryIds.some((e=>"temporary-effects"===e))){const t="temporary-effects";this._buildActions(i,{id:t},e)}}_buildFeatures(){if(!this.featureSubcategoryIds)return;const e="feature",t=new Map;for(const[e,s]of this.items){"feat"===s.type&&t.set(e,s)}if(0===t.size)return;const s=new Map,i=new Map;for(const[e,n]of t){const t=n.system.activation?.type,a=["","lair","legendary"];t&&!a.includes(t)&&s.set(e,n),t&&""!==t||i.set(e,n)}if(this.featureSubcategoryIds.some((e=>"active-features"===e))){const t="active-features";this._buildActions(s,{id:t},e);const i={id:t,name:this.i18n("tokenActionHud.dnd5e.activeFeatures")};this.actionSubcategoryIds&&this.buildActivations(s,i,e)}if(this.featureSubcategoryIds.some((e=>"passive-features"===e))){const t="passive-features";this._buildActions(i,{id:t},e);const s={id:t,name:this.i18n("tokenActionHud.dnd5e.passiveFeatures")};this.actionSubcategoryIds&&this.buildActivations(i,s,e)}}buildActivations(e,t,s="item"){const i=new Map,n=new Map,a=new Map,o=new Map,l=new Map,c=new Map,d=new Map;for(const[t,s]of e){const e=s.system?.activation?.type;switch(e){case"action":i.set(t,s);break;case"bonus":n.set(t,s);break;case"crew":a.set(t,s);break;case"lair":o.set(t,s);break;case"legendary":l.set(t,s);break;case"reaction":c.set(t,s);break;default:d.set(t,s)}}let r=null;for(const e of this.actionSubcategoryIds){switch(e){case"actions":r=i;break;case"bonus-actions":r=n;break;case"crew-actions":r=a;break;case"lair-actions":r=o;break;case"legendary-actions":r=l;break;case"reactions":r=c;break;case"other-actions":r=d}t.id=`${e}+${t.id}`,t.type="system-derived";const u={id:e,type:"system"};this.addSubcategoryToActionList(u,t),this._buildActions(r,t,s)}}_buildInventory(){if(!this.inventorySubcategoryIds)return;if(0===this.items.size)return;const e=new Map,t=new Map,s=new Map,i=new Map,n=new Map,a=new Map,o=new Map,l=new Map;for(const[c,d]of this.items){const r=d.system.equipped,u=d.system?.quantity>0,p=this._isActiveItem(d),h=this._isUsableItem(d),m=this._isEquippedItem(d),y=d.type;u&&p&&(r&&e.set(c,d),r||t.set(c,d),h&&"consumable"===y&&s.set(c,d),m&&("backpack"===y&&i.set(c,d),"equipment"===y&&n.set(c,d),"loot"===y&&a.set(c,d),"tool"===y&&o.set(c,d),"weapon"===y&&l.set(c,d)))}if(this.inventorySubcategoryIds.some((e=>"equipped"===e))){const t="equipped";if(this._buildActions(e,{id:t}),this.actionSubcategoryIds){const s={id:t,name:this.i18n("DND5E.Equipped")};this.buildActivations(e,s)}}if(this.inventorySubcategoryIds.some((e=>"unequipped"===e))){const e="unequipped";this._buildActions(t,{id:e})}if(this.inventorySubcategoryIds.some((e=>"containers"===e))){const e="containers";if(this._buildActions(i,{id:e}),this.actionSubcategoryIds){const t={id:e,name:this.i18n("DND5E.ItemTypeContainerPl")};this.buildActivations(i,t)}}if(this.inventorySubcategoryIds.some((e=>"equipment"===e))){const e="equipment";if(this._buildActions(n,{id:e}),this.actionSubcategoryIds){const t={id:e,name:this.i18n("DND5E.ItemTypeEquipmentPl")};this.buildActivations(n,t)}}if(this.inventorySubcategoryIds.some((e=>"loot"===e))){const e="loot";if(this._buildActions(a,{id:e}),this.actionSubcategoryIds){const t={id:e,name:this.i18n("DND5E.ItemTypeLootPl")};this.buildActivations(a,t)}}if(this.inventorySubcategoryIds.some((e=>"tools"===e))){const e="tools";if(this._buildActions(o,{id:e}),this.actionSubcategoryIds){const t={id:e,name:this.i18n("DND5E.ItemTypeToolPl")};this.buildActivations(o,t)}}if(this.inventorySubcategoryIds.some((e=>"weapons"===e))){const e="weapons";if(this._buildActions(l,{id:e}),this.actionSubcategoryIds){const t={id:e,name:this.i18n("DND5E.ItemTypeWeaponPl")};this.buildActivations(l,t)}}}_buildRests(){if(!this.subcategoryIds.some((e=>"rests"===e)))return;if(!this.actors.every((e=>"character"===e.type)))return;const e="utility",t={shortRest:{name:this.i18n("DND5E.ShortRest")},longRest:{name:this.i18n("DND5E.LongRest")}},s=Object.entries(t).map((t=>{const s=t[0],i=t[1].name,n=[e,this.actorId,this.tokenId,s].join(this.delimiter);return{id:s,name:i,encodedValue:n,selected:!0}}));this.addActionsToActionList(s,"rests")}_buildSkills(){if(!this.subcategoryIds.some((e=>"skills"===e)))return;const e="skill",t="multi"===this.actorId?game.dnd5e.config.skills:this.actor.system.skills;if(0===t.length)return;const s=Object.entries(t).map((s=>{try{const i=s[0],n=i.charAt(0).toUpperCase()+i.slice(1),a=this.abbreviateSkills?n:game.dnd5e.config.skills[i].label,o=[e,this.actorId,this.tokenId,i].join(this.delimiter);return{id:i,name:a,encodedValue:o,icon:this._getProficiencyIcon(t[i].value)}}catch(e){return l.error(s),null}})).filter((e=>!!e));this.addActionsToActionList(s,"skills")}_buildSpells(){if(!this.spellSubcategoryIds)return;const e="spell",t=new Map,s=new Map,i=new Map,n=new Map,a=new Map,o=new Map,l=new Map,c=new Map,d=new Map,r=new Map,u=new Map,p=new Map,h=new Map;for(const[e,m]of this.items){if("spell"===m.type){const y=this._isUsableItem(m),g=this._isUsableSpell(m);if(y&&g){switch(m.system.preparation.mode){case"atwill":u.set(e,m);break;case"innate":p.set(e,m);break;case"pact":h.set(e,m);break;default:switch(m.system.level){case 0:t.set(e,m);break;case 1:s.set(e,m);break;case 2:i.set(e,m);break;case 3:n.set(e,m);break;case 4:a.set(e,m);break;case 5:o.set(e,m);break;case 6:l.set(e,m);break;case 7:c.set(e,m);break;case 8:d.set(e,m);break;case 9:r.set(e,m)}}}}}const m=Object.entries(this.actor.system.spells).reverse();let y=null;const g=[];let b=this.showUnchargedItems,f=this.showUnchargedItems;for(const[e,t]of m){const s=t.value>0,i=t.max>0;"pact"===e&&(!f&&s&&i&&(f=!0),t.slotAvailable=f,y=[e,t]),e.startsWith("spell")?(!b&&s&&i&&(b=!0),t.slotAvailable=b,g.push([e,t])):s&&(t.slotsAvailable=!0,g.push(e,t))}if(y[1].slotAvailable){const e=g.findIndex((e=>e[0]==="spell"+y[1].level));g[e][1].slotsAvailable=!0}for(const m of this.spellSubcategoryIds){let b=null,f=null,v=null;switch(m){case"cantrips":b="0",f=t,v=this.i18n("tokenActionHud.dnd5e.cantrips");break;case"1st-level-spells":b="1",f=s,v=this.i18n("tokenActionHud.dnd5e.1stLevelSpells");break;case"2nd-level-spells":b="2",f=i,v=this.i18n("tokenActionHud.dnd5e.2ndLevelSpells");break;case"3rd-level-spells":b="3",f=n,v=this.i18n("tokenActionHud.dnd5e.3rdLevelSpells");break;case"4th-level-spells":b="4",f=a,v=this.i18n("tokenActionHud.dnd5e.4thLevelSpells");break;case"5th-level-spells":b="5",f=o,v=this.i18n("tokenActionHud.dnd5e.5thLevelSpells");break;case"6th-level-spells":b="6",f=l,v=this.i18n("tokenActionHud.dnd5e.6thLevelSpells");break;case"7th-level-spells":b="7",f=c,v=this.i18n("tokenActionHud.dnd5e.7thLevelSpells");break;case"8th-level-spells":b="8",f=d,v=this.i18n("tokenActionHud.dnd5e.8thLevelSpells");break;case"9th-level-spells":b="9",f=r,v=this.i18n("tokenActionHud.dnd5e.9thLevelSpells");break;case"at-will-spells":b="atwill",f=u,v=this.i18n("tokenActionHud.dnd5e.atWillSpells");break;case"innate-spells":b="innate",f=p,v=this.i18n("tokenActionHud.dnd5e.innateSpells");break;case"pact-spells":b="pact",f=h,v=this.i18n("tokenActionHud.dnd5e.pactSpells")}if(!f)return;const A=["1","2","3","4","5","6","7","8","9","pact"],k="pact"===b?y[1]:g.find((e=>e[0]===`spell${b}`))?.[1],I=k?.value,S=k?.max,_=k?.slotAvailable;if(!_&&A.includes(b))return;let w;S>0&&(w={},w.info1=`${I}/${S}`,this.addSubcategoryInfo({subcategoryId:m,subcategoryInfo:w})),this._buildActions(f,{id:m},e);const H={id:m,name:v,info1:w?.info1};this.actionSubcategoryIds&&this.buildActivations(f,H,e)}}_buildUtility(){if(this.subcategoryIds.some((e=>"utility"===e)))return;if(!this.actors.every((e=>"character"===e.type)))return;const e="utility",t={deathSave:{name:this.i18n("DND5E.DeathSave")},inspiration:{name:this.i18n("DND5E.Inspiration")}};("multi"===this.actorId||this.actor.system.attributes.hp.value>0)&&delete t.deathSave;const s=Object.entries(t).map((t=>{const s=t[0],i=t[1].name,n=[e,this.actorId,this.tokenId,s].join(this.delimiter);let a="";if("inspiration"===t[0]){a=`toggle${this.actors.every((e=>e.system.attributes?.inspiration))?" active":""}`}return{id:s,name:i,encodedValue:n,cssClass:a,selected:!0}}));this.addActionsToActionList(s,"utility")}_buildActions(e,t={},s="item"){if(0===e.size)return;if(!("string"==typeof t?t:t?.id))return;const i=[...e].map((e=>this._getAction(s,e[1])));this.addActionsToActionList(i,t)}_getAction(e,t){const s=t.id??t._id;let i=t?.name??t?.label;t?.system?.recharge&&!t?.system?.recharge?.charged&&t?.system?.recharge?.value&&(i+=` (${this.i18n("DND5E.Recharge")})`);let n="";if(Object.hasOwn(t,"disabled")){n=`toggle${t.disabled?"":" active"}`}const a=[e,this.actorId,this.tokenId,s].join(this.delimiter),o=this.getImage(t),l=this._getActivationTypeIcon(t?.system?.activation?.type);let c=null,d=null;"spell"===t.type?(c=this._getPreparedIcon(t),this.displaySpellInfo&&(d=this._getSpellInfo(t))):d=this._getItemInfo(t);return{id:s,name:i,encodedValue:a,cssClass:n,img:o,icon1:l,icon2:c,info1:d.info1,info2:d.info2,info3:d.info3,selected:!0}}_isActiveItem(e){if(this.showItemsWithoutActivationCosts)return!0;const t=Object.keys(game.dnd5e.config.abilityActivationTypes).filter((e=>"none"!==e)),s=e.system.activation,i=s?.type;return!(!s||!t.includes(i))}_isEquippedItem(e){const t=e.type;if(this.showUnequippedItems&&!["consumable","spell","feat"].includes(t))return!0;return!(!e.system.equipped||"consumable"===t)}_isUsableItem(e){if(this.showUnchargedItems)return!0;return!!e.system.uses}_isUsableSpell(e){if("character"!==this.actorType&&this.showUnequippedItems)return!0;const t=e.system.preparation.prepared;if(this.showUnpreparedSpells)return!0;const s=e.system.level,i=Object.keys(game.dnd5e.config.spellPreparationModes).filter((e=>"prepared"!==e)),n=e.system.preparation.mode;return!(0!==s&&!i.includes(n)&&!t)}_getItemInfo(e){return{info1:this._getQuantityData(e)??"",info2:this._getUsesData(e)??"",info3:this._getConsumeData(e)??""}}_getSpellInfo(e){const t=e.system.components;let s="",i="",n="";return t?.vocal&&(s+=this.i18n("DND5E.ComponentVerbal").charAt(0).toUpperCase()),t?.somatic&&(s+=this.i18n("DND5E.ComponentSomatic").charAt(0).toUpperCase()),t?.material&&(s+=this.i18n("DND5E.ComponentMaterial").charAt(0).toUpperCase()),t?.concentration&&(i+=this.i18n("DND5E.Concentration").charAt(0).toUpperCase()),t?.ritual&&(n+=this.i18n("DND5E.Ritual").charAt(0).toUpperCase()),{info1:s,info2:i,info3:n}}_getActors(){const e=["character","npc"],t=canvas.tokens.controlled.map((e=>e.actor));if(t.every((t=>e.includes(t.type))))return t}_getQuantityData(e){const t=e?.system?.quantity??0;return t>1?t:""}_getUsesData(e){const t=e?.system?.uses;return t&&(t.value>0||t.max>0)?`${t.value??"0"}${t.max>0?`/${t.max}`:""}`:""}_getConsumeData(e){const t=e?.system?.consume?.target,s=e?.system?.consume?.type;if("attribute"===s){const e=t.substr(0,t.lastIndexOf(".")),s=this.actor.system[e];return s?`${s.value??"0"}${s.max?`/${s.max}`:""}`:""}const i=this.items.get(t);if("charges"===s){const e=i?.system.uses;return e?.value?`${e.value}${e.max?`/${e.max}`:""}`:""}return i?.system?.quantity??""}_discardSlowItems(e){if(getSetting("showSlowActions"))return e;const t=["minute","hour","day"],s=new Map;for(const[i,n]of e){const e=n.system.activation,a=n.system.activation?.type;e&&!t.includes(a)&&s.set([i,n])}return s}_getProficiencyIcon(e){return{0:"",.5:'<i class="fas fa-adjust"></i>',1:'<i class="fas fa-check"></i>',2:'<i class="fas fa-check-double"></i>'}[e]}_getActivationTypeIcon(e){return{bonus:'<i class="fas fa-plus"></i>',crew:'<i class="fas fa-users"></i>',day:'<i class="fas fa-hourglass-end"></i>',hour:'<i class="fas fa-hourglass-half"></i>',lair:'<i class="fas fa-home"></i>',minute:'<i class="fas fa-hourglass-start"></i>',legendary:'<i class="fas fa-dragon"></i>',reaction:'<i class="fas fa-bolt"></i>',special:'<i class="fas fa-star"></i>'}[e]}_getPreparedIcon(e){const t=e.system.level,s=e.system.preparation.mode;if(e.system.preparation.prepared&&"prepared"===s&&0!==t)return'<i class="fas fa-sun"></i>'}}class RollHandler extends a{async doHandleActionEvent(e,t){const s=t.split("|");4!==s.length&&super.throwInvalidValueErr();const i=s[0],n=s[1],a=s[2],o=s[3];if("multi"===a&&"toggleCombat"!==o)for(const t of canvas.tokens.controlled){const s=t.actor?.id,n=t.id;await this._handleMacros(e,i,s,n,o)}else await this._handleMacros(e,i,n,a,o)}async _handleMacros(e,t,s,i,n){switch(t){case"ability":this._rollAbility(e,s,i,n);break;case"abilityCheck":this._rollAbilityTest(e,s,i,n);break;case"abilitySave":this._rollAbilitySave(e,s,i,n);break;case"condition":if(!i)return;await this._toggleCondition(e,i,n);break;case"effect":await this._toggleEffect(e,s,i,n);break;case"feature":case"item":case"spell":case"weapon":this.isRenderItem()?this.doRenderItem(s,i,n):this._useItem(e,s,i,n);break;case"magicItem":this._rollMagicItem(e,s,i,n);break;case"skill":this._rollSkill(e,s,i,n);break;case"utility":await this._performUtilityMacro(e,s,i,n)}}_rollAbility(e,t,s,i){super.getActor(t,s).rollAbility(i,{event:e})}_rollAbilitySave(e,t,s,i){super.getActor(t,s).rollAbilitySave(i,{event:e})}_rollAbilityTest(e,t,s,i){super.getActor(t,s).rollAbilityTest(i,{event:e})}_rollMagicItem(e,t,s,i){const n=super.getActor(t,s),a=i.split(">"),o=a[0],l=a[1];MagicItems.actor(n.id).roll(o,l),Hooks.callAll("forceUpdateTokenActionHud")}_rollSkill(e,t,s,i){super.getActor(t,s).rollSkill(i,{event:e})}_useItem(e,t,s,i){const n=super.getActor(t,s),a=super.getItem(n,i);if(!this._needsRecharge(a))return a.use({event:e});a.rollRecharge()}_needsRecharge(e){return e.system.recharge&&!e.system.recharge.charged&&e.system.recharge.value}async _performUtilityMacro(e,t,s,i){const n=super.getActor(t,s),a=super.getToken(s);switch(i){case"deathSave":n.rollDeathSave({event:e});break;case"endTurn":if(!a)break;game.combat?.current?.tokenId===s&&await(game.combat?.nextTurn());break;case"initiative":await this._rollInitiative(t);break;case"inspiration":{const e=!n.system.attributes.inspiration;n.update({"data.attributes.inspiration":e});break}case"longRest":n.longRest();break;case"shortRest":n.shortRest();break;case"toggleCombat":if(0===canvas.tokens.controlled.length)break;await canvas.tokens.controlled[0].toggleCombat(),Hooks.callAll("forceUpdateTokenActionHud");break;case"toggleVisibility":if(!a)break;a.toggleVisibility(),Hooks.callAll("forceUpdateTokenActionHud")}}async _rollInitiative(e,t){const s=super.getActor(e,t);await s.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHud")}async _toggleCondition(e,t,s,i=null){const n=super.getToken(t),a=this.isRightClick(e);if(game.dfreds&&i?.flags?.isConvenient){const e=i.label;game.dfreds.effectInterface._toggleEffect(e)}else{const e=this.findCondition(s);if(!e)return;a?await n.toggleEffect(e,{overlay:!0}):await n.toggleEffect(e)}Hooks.callAll("forceUpdateTokenActionHud")}findCondition(e){return CONFIG.statusEffects.find((t=>t.id===e))}async _toggleEffect(e,t,s,i){const n=super.getActor(t,s),a=("find"in n.effects.entries?n.effects.entries:n.effects).find((e=>e.id===i));if(!a)return;this.isRightClick(e)?await a.delete():await a.update({disabled:!a.disabled}),Hooks.callAll("forceUpdateTokenActionHud")}}class MagicItemActionListExtender extends s{extendActionList(e,t){const s=t?.actor?.id,i=t?.token?.id;if(!s)return;const n=MagicItems.actor(s);if(!n)return;const a=n.items??[];if(0===a.length)return;const o=[];a.forEach((e=>{if(e.attuned&&!this._isItemAttuned(e))return;if(e.equipped&&!this._isItemEquipped(e))return;const t=`magic-items_${e.id}`,n=e.name,a=this.initializeEmptySubcategory(t,t,n,"system");a.info1=`${e.uses}/${e.charges}`;const l=e.ownedEntries.map((t=>{const n=t.item,a=n.id,o=n.name,l=["magicItem",s,i,`${e.id}>${a}`].join("|"),c=this.getImage(n),d=n.consumption;let r="";return n.baseLevel&&(r=`${this.i18n("DND5E.AbbreviationLevel")} ${n.baseLevel}`),{id:a,name:o,encodedValue:l,img:c,info1:d,info2:r}}));this.addToSubcategoryList(o,t,a,l)})),this.addSubcategoriesToActionList(e,o,"magic-items")}_isItemEquipped(e){return e.item.system.equipped}_isItemAttuned(e){const t=e.item.system;if(t.attunement){const e=CONFIG.DND5E.attunementTypes?.ATTUNED??2;return t.attunement===e}return!!t.attuned&&t.attuned}}class RollHandlerObsidian extends RollHandler{_rollAbilityTest(e,t,s,i){const n=super.getActor(t,s);OBSIDIAN.Items.roll(n,{roll:"abl",abl:i})}_rollAbilitySave(e,t,s,i){const n=super.getActor(t,s);OBSIDIAN.Items.roll(n,{roll:"save",save:i})}_rollSkill(e,t,s,i){const n=super.getActor(t,s);OBSIDIAN.Items.roll(n,{roll:"skl",skl:i})}_useItem(e,t,s,i){const n=super.getActor(t,s);OBSIDIAN.Items.roll(n,{roll:"item",id:i})}}function register(e){const t="token-action-hud-dnd5e";game.settings.register(t,"abbreviateSkills",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.abbreviateSkills.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.abbreviateSkills.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showSlowActions",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showSlowActions.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showSlowActions.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"displaySpellInfo",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.displaySpellInfo.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.displaySpellInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showUnchargedItems",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnchargedItems.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnchargedItems.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t,"showUnequippedItems",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnequippedItems.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnequippedItems.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showUnpreparedSpells",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnpreparedSpells.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showUnpreparedSpells.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}}),game.settings.register(t,"showItemsWithoutActivationCosts",{name:game.i18n.localize("tokenActionHud.dnd5e.settings.showItemsWithoutActivationCosts.name"),hint:game.i18n.localize("tokenActionHud.dnd5e.settings.showItemsWithoutActivationCosts.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}})}class SystemManager extends o{doGetCategoryManager(e){return new i(e)}doGetActionHandler(e,t){const s=new ActionHandler(e,t);return o.isModuleActive("magicitems")&&s.addFurtherActionHandler(new MagicItemActionListExtender),s}getAvailableRollHandlers(){let e="Core D&D5e";o.isModuleActive("midi-qol")&&(e+=` [supports ${o.getModuleTitle("midi-qol")}]`);const t={core:e};return o.addHandler(t,"obsidian"),t}doGetRollHandler(e){let t;if("obsidian"===e)t=new RollHandlerObsidian;else t=new RollHandler;return t}doRegisterSettings(e){register(e)}async doRegisterDefaultFlags(){const e={categories:{inventory:{id:"inventory",name:this.i18n("DND5E.Inventory"),subcategories:{inventory_weapons:{id:"weapons",name:this.i18n("DND5E.ItemTypeWeaponPl"),type:"system"},inventory_equipment:{id:"equipment",name:this.i18n("DND5E.ItemTypeEquipmentPl"),type:"system"},inventory_consumables:{id:"consumables",name:this.i18n("DND5E.ItemTypeConsumablePl"),type:"system"},inventory_tools:{id:"tools",name:this.i18n("DND5E.ItemTypeToolPl"),type:"system"},inventory_containers:{id:"containers",name:this.i18n("DND5E.ItemTypeContainerPl"),type:"system"},inventory_loot:{id:"loot",name:this.i18n("DND5E.ItemTypeLootPl"),type:"system"}}},features:{id:"features",name:this.i18n("DND5E.Features"),subcategories:{"features_active-features":{id:"active-features",name:this.i18n("tokenActionHud.dnd5e.activeFeatures"),type:"system"},"features_passive-features":{id:"passive-features",name:this.i18n("tokenActionHud.dnd5e.passiveFeatures"),type:"system"}}},spells:{id:"spells",name:this.i18n("DND5E.ItemTypeSpellPl"),subcategories:{"spells_at-will-spells":{id:"at-will-spells",name:this.i18n("tokenActionHud.dnd5e.atWillSpells"),type:"system"},"spells_innate-spells":{id:"innate-spells",name:this.i18n("tokenActionHud.dnd5e.innateSpells"),type:"system"},"spells_pact-spells":{id:"pact-spells",name:this.i18n("tokenActionHud.dnd5e.pactSpells"),type:"system"},spells_cantrips:{id:"cantrips",name:this.i18n("tokenActionHud.dnd5e.cantrips"),type:"system"},"spells_1st-level-spells":{id:"1st-level-spells",name:this.i18n("tokenActionHud.dnd5e.1stLevelSpells"),type:"system"},"spells_2nd-level-spells":{id:"2nd-level-spells",name:this.i18n("tokenActionHud.dnd5e.2ndLevelSpells"),type:"system"},"spells_3rd-level-spells":{id:"3rd-level-spells",name:this.i18n("tokenActionHud.dnd5e.3rdLevelSpells"),type:"system"},"spells_4th-level-spells":{id:"4th-level-spells",name:this.i18n("tokenActionHud.dnd5e.4thLevelSpells"),type:"system"},"spells_5th-level-spells":{id:"5th-level-spells",name:this.i18n("tokenActionHud.dnd5e.5thLevelSpells"),type:"system"},"spells_6th-level-spells":{id:"6th-level-spells",name:this.i18n("tokenActionHud.dnd5e.6thLevelSpells"),type:"system"},"spells_7th-level-spells":{id:"7th-level-spells",name:this.i18n("tokenActionHud.dnd5e.7thLevelSpells"),type:"system"},"spells_8th-level-spells":{id:"8th-level-spells",name:this.i18n("tokenActionHud.dnd5e.8thLevelSpells"),type:"system"},"spells_9th-level-spells":{id:"9th-level-spells",name:this.i18n("tokenActionHud.dnd5e.9thLevelSpells"),type:"system"}}},attributes:{id:"attributes",name:this.i18n("DND5E.Attributes"),subcategories:{attributes_abilities:{id:"abilities",name:this.i18n("tokenActionHud.dnd5e.abilities"),type:"system"},attributes_skills:{id:"skills",name:this.i18n("tokenActionHud.dnd5e.skills"),type:"system"}}},effects:{id:"effects",name:this.i18n("DND5E.Effects"),subcategories:{"effects_temporary-effects":{id:"temporary-effects",name:this.i18n("DND5E.EffectTemporary"),type:"system"},"effects_passive-effects":{id:"passive-effects",name:this.i18n("DND5E.EffectPassive"),type:"system"}}},conditions:{id:"conditions",name:this.i18n("tokenActionHud.dnd5e.conditions"),subcategories:{conditions_conditions:{id:"conditions",name:this.i18n("tokenActionHud.dnd5e.conditions"),type:"system"}}},utility:{id:"utility",name:this.i18n("tokenActionHud.utility"),subcategories:{utility_combat:{id:"combat",name:this.i18n("tokenActionHud.combat"),type:"system"},utility_token:{id:"token",name:this.i18n("tokenActionHud.token"),type:"system"},utility_rests:{id:"rests",name:this.i18n("tokenActionHud.dnd5e.rests"),type:"system"},utility_utility:{id:"utility",name:this.i18n("tokenActionHud.utility"),type:"system"}}}},subcategories:[{id:"abilities",name:this.i18n("tokenActionHud.dnd5e.abilities"),type:"system"},{id:"checks",name:this.i18n("tokenActionHud.dnd5e.checks"),type:"system"},{id:"combat",name:this.i18n("tokenActionHud.combat"),type:"system"},{id:"conditions",name:this.i18n("tokenActionHud.dnd5e.conditions"),type:"system"},{id:"rests",name:this.i18n("tokenActionHud.dnd5e.rests"),type:"system"},{id:"saves",name:this.i18n("DND5E.ClassSaves"),type:"system"},{id:"skills",name:this.i18n("tokenActionHud.dnd5e.skills"),type:"system"},{id:"token",name:this.i18n("tokenActionHud.token"),type:"system"},{id:"utility",name:this.i18n("tokenActionHud.utility"),type:"system"},{id:"actions",name:this.i18n("DND5E.ActionPl"),type:"system"},{id:"bonus-actions",name:this.i18n("tokenActionHud.dnd5e.bonusActions"),type:"system"},{id:"crew-actions",name:this.i18n("tokenActionHud.dnd5e.crewActions"),type:"system"},{id:"lair-actions",name:this.i18n("tokenActionHud.dnd5e.lairActions"),type:"system"},{id:"legendary-actions",name:this.i18n("tokenActionHud.dnd5e.legendaryActions"),type:"system"},{id:"other-actions",name:this.i18n("tokenActionHud.dnd5e.otherActions"),type:"system"},{id:"reactions",name:this.i18n("DND5E.ReactionPl"),type:"system"},{id:"consumables",name:this.i18n("DND5E.ItemTypeConsumablePl"),type:"system"},{id:"containers",name:this.i18n("DND5E.ItemTypeContainerPl"),type:"system"},{id:"temporary-effects",name:this.i18n("DND5E.EffectTemporary"),type:"system"},{id:"passive-effects",name:this.i18n("DND5E.EffectPassive"),type:"system"},{id:"equipment",name:this.i18n("DND5E.ItemTypeEquipmentPl"),type:"system"},{id:"loot",name:this.i18n("DND5E.ItemTypeLootPl"),type:"system"},{id:"tools",name:this.i18n("DND5E.ItemTypeToolPl"),type:"system"},{id:"weapons",name:this.i18n("DND5E.ItemTypeWeaponPl"),type:"system"},{id:"equipped",name:this.i18n("DND5E.Equipped"),type:"system"},{id:"unequipped",name:this.i18n("DND5E.Unequipped"),type:"system"},{id:"active-features",name:this.i18n("tokenActionHud.dnd5e.activeFeatures"),type:"system"},{id:"passive-features",name:this.i18n("tokenActionHud.dnd5e.passiveFeatures"),type:"system"},{id:"at-will-spells",name:this.i18n("tokenActionHud.dnd5e.atWillSpells"),type:"system"},{id:"cantrips",name:this.i18n("tokenActionHud.dnd5e.cantrips"),type:"system"},{id:"innate-spells",name:this.i18n("tokenActionHud.dnd5e.innateSpells"),type:"system"},{id:"pact-spells",name:this.i18n("tokenActionHud.dnd5e.pactSpells"),type:"system"},{id:"1st-level-spells",name:this.i18n("tokenActionHud.dnd5e.1stLevelSpells"),type:"system"},{id:"2nd-level-spells",name:this.i18n("tokenActionHud.dnd5e.2ndLevelSpells"),type:"system"},{id:"3rd-level-spells",name:this.i18n("tokenActionHud.dnd5e.3rdLevelSpells"),type:"system"},{id:"4th-level-spells",name:this.i18n("tokenActionHud.dnd5e.4thLevelSpells"),type:"system"},{id:"5th-level-spells",name:this.i18n("tokenActionHud.dnd5e.5thLevelSpells"),type:"system"},{id:"6th-level-spells",name:this.i18n("tokenActionHud.dnd5e.6thLevelSpells"),type:"system"},{id:"7th-level-spells",name:this.i18n("tokenActionHud.dnd5e.7thLevelSpells"),type:"system"},{id:"8th-level-spells",name:this.i18n("tokenActionHud.dnd5e.8thLevelSpells"),type:"system"},{id:"9th-level-spells",name:this.i18n("tokenActionHud.dnd5e.9thLevelSpells"),type:"system"}]};game.modules.get("magicitems")?.active&&(e.subcategories.push({id:"magic-items",name:this.i18n("tokenActionHud.dnd5e.magicItems"),type:"system"}),e.subcategories.sort(((e,t)=>e.id.localeCompare(t.id)))),await game.user.setFlag(this.namespace,"default",e)}}export{ActionHandler,t as CoreActionHandler,s as CoreActionListExtender,i as CoreCategoryManager,n as CorePreRollHandler,a as CoreRollHandler,o as CoreSystemManager,l as Logger,MagicItemActionListExtender,RollHandler,RollHandlerObsidian,SystemManager,getSetting,register,setSetting};
